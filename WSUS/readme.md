# WSUS updates on CyberArk on-prem vaults

These scripts are the ones supplied by CyberArk, with slight modifications. Due to these modifications the signature will be invalid and it will fail a signature check. 
The scripts that are not of CyberArk origin are simple scripts for starting the scripts in order and to check if the services are running properly after a reboot.
The scripts sends email notifications as well as write to the Windows Event Viewer.

## Input needed

The scripts needs to be modified to match your SMTP server, the sender email, as well as the recipient of the emails generated by the system.

For the Windows Event Viewer logging to work, you need to create a new log source. This is done by typing this in an administrative powershell window on each vault
the scripts run on:

    New-EventLog -LogName Application -Source "VaultWUUpdate"
  
You will also have to specify the path of the scriptfiles, as the StartWUUpdate.ps1 script navigates to that folder. This can be circumvented by specifying "Start in" section of the task scheduler, or starting the script from the folder its resides in.

## What does the scripts do?

The first script that should be run is the "ConfigureWSUS.ps1" script. This defines in registry which WSUS server the vault is to connect to. A couple of things to consider here:

1. If the WSUS requires https, the vault needs the Root CA certificate of the WSUS server to be able to trust it. 
2. If the Vault uses a FQDN to connect to the WSUS, add that entry to the hosts file (as per CyberArk recommendations). 
3. If you type the WSUS servername wrong, simply run the script again, with the correct name.

The syntax is:

    .\ConfigureWSUS.ps1 "http://CompanyWSUS:8530"

The scripts in general does the following when run in the correct order:

1. Starts the services needed to be able to run Windows Updates
2. Download the updates from the defined WSUS server
3. Installs the downloaded updates and logs how many are successful and how many failed
4. Sends an email of the statistics and writes to the Event Viewer
5. Checks if the server has a pending reboot
6. Stops the services and removes any temporary firewall rules put in to allow access to SMTP server or WSUS server
7. Reboots the server if it is pending
8. Checks the CyberArk services for "Running" status after reboot, and sends a mail if something is wrong.
